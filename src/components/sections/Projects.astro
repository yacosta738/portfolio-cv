---
import Section from "@atoms/Section.astro";
import { Icon } from "astro-icon/components";
import { type Lang, useTranslations } from "@/i18n";
import type Project from "@/resume/project/project.model";

// Props interface
interface Props {
	projects?: Project[];
}

const { projects = [] } = Astro.props as Props;
const currentLocale = Astro.params.lang as Lang;
const t = useTranslations(currentLocale);

// Robust translation helper: if t returns the key or empty string, treat as missing and use fallback
const tr = (
	key: string,
	params: Record<string, unknown> = {},
	fallback = "",
) => {
	// `t` is typed by the i18n layer; cast through unknown to satisfy strict TS rules without using `any`
	const s = t(
		key as unknown as Parameters<typeof t>[0],
		params as unknown as Parameters<typeof t>[1],
	) as unknown as string | undefined;
	return s && s !== key ? s : fallback;
};
---

{projects.length > 0 && (
  <Section title={t('projects')}>
  <ul class="grid grid-cols-[repeat(auto-fit,minmax(200px,1fr))] gap-4 -mx-4 sm:mx-0">
    {
      projects.map(
        ({ url, description, highlights, name, isActive, github }) => {
          return (
            <li>
              <article class="rounded-lg border border-base-300 gap-4 flex flex-col p-4 h-full">
                <header class="flex-1">
                  <h3 class="mb-1">
                    <a 
                      href={url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      title={tr('viewProject', { name }, `View project ${name}`)}
                      class="text-foreground hover:underline focus:underline hover:text-foreground-muted"
                    >
                      {name}
                    </a>
                    {isActive && <span class="text-green-600 animate-flicker ml-1">â€¢</span>}
                    {github && (() => {
                      const linkTitle = tr('viewSource', {}, `View source`);
                      const ariaLabel = tr('viewSourceOnGitHub', {}, `View source on GitHub`);

                      return (
                        <a
                          class="ml-1.5 inline-block text-foreground-muted"
                          href={github}
                          target="_blank"
                          rel="noopener noreferrer"
                          title={linkTitle}
                          aria-label={`${ariaLabel}: ${name}`}
                        >
                          <Icon name="lucide:github" class="size-4" aria-hidden="true" />
                        </a>
                      )
                    })()}
                  </h3>
                  <p class="text-xs leading-tight mb-1 text-foreground-muted">{description}</p>
                </header>
                <footer class="flex flex-wrap gap-1 text-[0.6rem]">
                  {highlights?.map((highlight) => {
                    return <span class="rounded-md bg-base-200 dark:bg-base-100 text-foreground-muted text-[0.6rem] font-medium px-2.5 py-1 border border-base-300">{highlight}</span>
                  })}
                </footer>
              </article>
            </li>
          )
        }
      )
    }
  </ul>
  </Section>
)}